<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예산안 분석 - 판매실적 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="../assets/css/common.css" rel="stylesheet">
    <script src="../assets/js/sheets-api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .tree-item { transition: all 0.2s; }
        .tree-item:hover { background-color: #f9fafb; }
        .tree-toggle { cursor: pointer; user-select: none; }
        .tree-children { margin-left: 1.5rem; }
        .collapsed { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4"><a href="../index.html" class="text-lg font-semibold text-gray-900">← 대시보드로 돌아가기</a></div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">예산안 분석</h1>
            <p class="text-gray-600">연도별 예산을 비교하고 증감 추이를 분석합니다.</p>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">기준연도</label>
                    <select id="baseYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadData()">
                        <option value="">선택안함</option><option value="2024">2024</option><option value="2025" selected>2025</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">분석연도</label>
                    <select id="compareYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadData()">
                        <option value="" selected>선택안함</option><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">검색</label>
                    <input type="text" id="searchKeyword" placeholder="수요기관/과/사업명 검색..." class="w-full px-4 py-2 border border-gray-300 rounded-lg" onkeyup="if(event.key==='Enter') applySearch()">
                </div>
            </div>
            <div class="flex justify-between items-center"><div class="text-sm text-gray-600"><span id="modeDescription">데이터를 불러오는 중...</span></div><div class="flex gap-2"><button onclick="expandAll()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">전체 펼치기</button><button onclick="collapseAll()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">전체 접기</button></div></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4"><div class="text-sm text-gray-600 mb-1">총 예산</div><div class="text-2xl font-bold text-gray-900" id="statTotalBudget">-</div></div>
            <div class="bg-white rounded-lg shadow-md p-4"><div class="text-sm text-gray-600 mb-1">수요기관</div><div class="text-2xl font-bold text-teal-600" id="statAgencyCount">-</div></div>
            <div class="bg-white rounded-lg shadow-md p-4"><div class="text-sm text-gray-600 mb-1">사업 수</div><div class="text-2xl font-bold text-blue-600" id="statProjectCount">-</div></div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 border-b bg-gray-50"><h2 class="text-lg font-bold text-gray-900">예산 계층 구조</h2></div>
            <div id="budgetTree" class="p-4"><div class="text-center text-gray-500 py-8">데이터를 불러오는 중...</div></div>
        </div>
    </main>

    <script src="../assets/js/common.js"></script>
    <script>
        let allData = []; let treeData = {};
        document.addEventListener('DOMContentLoaded', async () => { await loadData(); });

        async function loadData() {
            const baseYear = document.getElementById('baseYear').value;
            const compareYear = document.getElementById('compareYear').value;
            if (!baseYear) { document.getElementById('budgetTree').innerHTML = '<div class="text-center text-gray-500 py-8">기준연도를 선택해주세요.</div>'; return; }
            try {
                allData = await window.sheetsAPI.loadCSVData('budgetAnalysis');
                const filteredData = allData.filter(d => String(d['연도']).trim() === String(baseYear).trim());
                buildTree(filteredData); updateStats(filteredData); renderTree();
                document.getElementById('modeDescription').textContent = compareYear ? `${baseYear}년과 ${compareYear}년 예산을 비교합니다.` : `${baseYear}년 예산 데이터를 표시합니다.`;
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                document.getElementById('budgetTree').innerHTML = '<div class="text-center text-red-500 py-8">데이터 로드 실패. API 연결을 확인해주세요.</div>';
            }
        }

        function buildTree(data) {
            treeData = {};
            data.forEach(item => {
                const agency = item['수요기관명'] || '미분류'; const dept = item['부서'] || '미분류';
                const project = item['세부사업'] || '미분류'; const subProject = item['사업명'] || '-';
                const budget = parseInt(String(item['예산액 (천원)']).replace(/,/g, '')) || 0;
                if (!treeData[agency]) treeData[agency] = { name: agency, budget: 0, children: {} };
                treeData[agency].budget += budget;
                if (!treeData[agency].children[dept]) treeData[agency].children[dept] = { name: dept, budget: 0, children: {} };
                treeData[agency].children[dept].budget += budget;
                if (!treeData[agency].children[dept].children[project]) treeData[agency].children[dept].children[project] = { name: project, budget: 0, children: [] };
                treeData[agency].children[dept].children[project].budget += budget;
                treeData[agency].children[dept].children[project].children.push({ name: subProject, budget: budget });
            });
        }

        function updateStats(data) {
            const totalBudget = data.reduce((sum, d) => sum + (parseInt(String(d['예산액 (천원)']).replace(/,/g, '')) || 0), 0);
            const agencyCount = new Set(data.map(d => d['수요기관명'])).size;
            document.getElementById('statTotalBudget').textContent = (totalBudget / 1000).toFixed(1) + '백만원';
            document.getElementById('statAgencyCount').textContent = agencyCount + '개';
            document.getElementById('statProjectCount').textContent = data.length + '건';
        }

        function renderTree() {
            const container = document.getElementById('budgetTree');
            if (Object.keys(treeData).length === 0) { container.innerHTML = '<div class="text-center text-gray-500 py-8">데이터가 없습니다.</div>'; return; }
            let html = '';
            const sortedAgencies = Object.values(treeData).sort((a, b) => b.budget - a.budget);
            sortedAgencies.forEach(agency => {
                const agencyId = 'node_' + Math.random().toString(36).substr(2, 9);
                html += `
                    <div class="tree-item border-b">
                        <div class="tree-toggle flex justify-between items-center py-3 px-2 font-bold" onclick="toggleNode('${agencyId}')">
                            <div><span id="${agencyId}_icon">▼</span><span class="ml-2 text-gray-900">${agency.name}</span></div>
                            <div class="text-teal-600">${formatBudget(agency.budget)}</div>
                        </div>
                        <div id="${agencyId}" class="tree-children">`;
                Object.values(agency.children).sort((a, b) => b.budget - a.budget).forEach(dept => {
                    const deptId = 'node_' + Math.random().toString(36).substr(2, 9);
                    html += `
                        <div class="tree-item"><div class="tree-toggle flex justify-between items-center py-2 px-2 font-semibold" onclick="toggleNode('${deptId}')">
                            <div><span id="${deptId}_icon">▼</span><span class="ml-2 text-gray-800">${dept.name}</span></div>
                            <div class="text-gray-700">${formatBudget(dept.budget)}</div>
                        </div><div id="${deptId}" class="tree-children">`;
                    Object.values(dept.children).sort((a, b) => b.budget - a.budget).forEach(project => {
                        const projId = 'node_' + Math.random().toString(36).substr(2, 9);
                        html += `
                            <div class="tree-item"><div class="tree-toggle flex justify-between items-center py-2 px-2" onclick="toggleNode('${projId}')">
                                <div><span id="${projId}_icon">▼</span><span class="ml-2 text-gray-700">${project.name}</span></div>
                                <div class="text-gray-600">${formatBudget(project.budget)}</div>
                            </div><div id="${projId}" class="tree-children">`;
                        project.children.sort((a, b) => b.budget - a.budget).forEach(sub => {
                            html += `<div class="flex justify-between items-center py-2 px-2 text-sm"><div class="text-gray-600">• ${sub.name}</div><div class="text-gray-500">${formatBudget(sub.budget)}</div></div>`;
                        });
                        html += '</div></div>';
                    });
                    html += '</div></div>';
                });
                html += '</div></div>';
            });
            container.innerHTML = html;
        }

        function toggleNode(id) { const node = document.getElementById(id); const icon = document.getElementById(id + '_icon'); node.classList.toggle('collapsed'); icon.textContent = node.classList.contains('collapsed') ? '▶' : '▼'; }
        function expandAll() { document.querySelectorAll('.tree-children').forEach(n => n.classList.remove('collapsed')); document.querySelectorAll('[id$="_icon"]').forEach(i => i.textContent = '▼'); }
        function collapseAll() { document.querySelectorAll('.tree-children').forEach(n => n.classList.add('collapsed')); document.querySelectorAll('[id$="_icon"]').forEach(i => i.textContent = '▶'); }
        function applySearch() {
            const kw = document.getElementById('searchKeyword').value.toLowerCase();
            document.querySelectorAll('.tree-item').forEach(item => {
                if (!kw || item.textContent.toLowerCase().includes(kw)) {
                    item.style.display = '';
                    let p = item.parentElement; while(p && p.classList.contains('tree-children')) { p.classList.remove('collapsed'); p = p.parentElement; }
                } else item.style.display = 'none';
            });
        }
        function formatBudget(amt) { return amt >= 1000000 ? (amt / 1000000).toFixed(1) + '십억원' : (amt >= 1000 ? (amt / 1000).toFixed(0) + '백만원' : amt.toLocaleString() + '천원'); }
    </script>
</body>
</html>
